<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="/webjars/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="/webjars/jquery/jquery.min.js"></script>
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
</head>
<body>
<noscript><h2 style="color: #ff0000"></h2></noscript>
<div id="main-content" class="container">
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="msg">What is your message?</label>
                <input type="text" id="msg" class="form-control" placeholder="Your message here...">
            </div>
            <button id="send" class="btn btn-default">전송</button>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <table id="conversation" class="table table-striped">
                <thead>
                <tr>
                    <th><h1>[[${room.name}]]</h1></th>
                </tr>
                </thead>
                <tbody id="msgArea">
                <tr th:each="chat : ${chatList}">
                    <td th:text="${chat.senderName} + ': ' + ${chat.message} + ' ' + ${#dates.format(chat.sendTime, 'HH:mm')}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <form th:action="@{/exitRoom}" method="post">
        <button id="exit" class="btn btn-secondary">나가기</button>
    </form>
</div>
</body>
<script th:inline="javascript">

    $(function(){
        var roomId = [[${room.roomId}]];
        var roomName = [[${room.name}]];
        var sender = [[${session.nickname}]];
        var receiver;

        if(sender == [[${room.regisName}]]){
            receiver = [[${room.buyerName}]];
        }
        else if(sender == [[${room.buyerName}]]){
            receiver = [[${room.regisName}]];
        }

        var socket = new SockJS("/stomp/chat");
        var stomp = Stomp.over(socket);
        var now = new Date();

        stomp.connect({}, function(){
            console.log("server connected...");
            stomp.subscribe("/sub/chat/room/" + roomId, function(chat){
                var content = JSON.parse(chat.body);
                var msgDate = sendMsgDate(content.sendTime);
                $("#msgArea").append("<tr><td>" + content.senderName + ": " + content.message + " " + msgDate + "</td></tr>");
            })
        });

        $("#send").on("click", function(e){
            var msg = document.getElementById("msg");
            now = new Date();
            stomp.send('/pub/chat/message', {}, JSON.stringify({
                chRoomId: roomId,
                senderName: sender,
                receiverName: receiver,
                sendTime: now,
                message: msg.value,
                checkRead: 0
             }));
            msg.value = "";
        });

        $("#exit").on("click", function(e) {
            if(stompClient !== null){
                if(confirm("채팅방을 나가시겠습니까?")){
                    $("#msgArea").append("<tr><td>" + username + "님이 나가셨습니다." + "</td></tr>");
                    stompClient.disconnect();
                }
                else{
                    e.preventDefault();
                }
            }
        });
    })
    function sendMsgDate(msgDate){
        var date;
        var time = new Date();

        var year = time.getHours();
        var minutes = time.getMinutes();

        date = year + ":" + minutes;
        return date;
    }

    function getCookie(cookieName){
        cookieName = cookieName + '=';
        var cookieData = document.cookie;
        var start = cookieData.indexOf(cookieName);
        var value = '';
        if(start != -1){
            start += cookieName.length;
            var end = cookieData.indexOf(';', start);
            if(end == -1){
                end = cookieData.length;
            }
            value = cookieData.substring(start, end);
        }
        return unescape(value);
    }
</script>
</html>